{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/ohong/dev/straude/apps/web/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { cookies } from \"next/headers\";\n\nexport async function createClient() {\n  const cookieStore = await cookies();\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll();\n        },\n        setAll(cookiesToSet: { name: string; value: string; options?: Record<string, unknown> }[]) {\n          cookiesToSet.forEach(({ name, value, options }) =>\n            cookieStore.set(name, value, options as any)\n          );\n        },\n      },\n    }\n  );\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,iNAAO;IACjC,OAAO,IAAA,kRAAkB,oKAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAkF;gBACvF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;YAEjC;QACF;IACF;AAEJ"}},
    {"offset": {"line": 78, "column": 0}, "map": {"version":3,"sources":["file:///Users/ohong/dev/straude/apps/web/lib/api/cli-auth.ts"],"sourcesContent":["import { createHmac, timingSafeEqual } from \"node:crypto\";\n\ninterface JwtPayload {\n  sub: string;\n  username?: string;\n  iat: number;\n  exp: number;\n}\n\nfunction base64urlEncode(data: string): string {\n  return Buffer.from(data, \"utf-8\")\n    .toString(\"base64\")\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\")\n    .replace(/=+$/, \"\");\n}\n\nfunction base64urlDecode(str: string): string {\n  const padded = str + \"=\".repeat((4 - (str.length % 4)) % 4);\n  return Buffer.from(padded.replace(/-/g, \"+\").replace(/_/g, \"/\"), \"base64\").toString(\"utf-8\");\n}\n\nfunction sign(header: string, payload: string, secret: string): string {\n  const input = `${header}.${payload}`;\n  return createHmac(\"sha256\", secret)\n    .update(input)\n    .digest(\"base64\")\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\")\n    .replace(/=+$/, \"\");\n}\n\n/**\n * Create a signed JWT for CLI authentication.\n */\nexport function createCliToken(userId: string, username: string | null): string {\n  const secret = process.env.CLI_JWT_SECRET;\n  if (!secret) throw new Error(\"CLI_JWT_SECRET not configured\");\n\n  const header = base64urlEncode(JSON.stringify({ alg: \"HS256\", typ: \"JWT\" }));\n  const now = Math.floor(Date.now() / 1000);\n  const payload = base64urlEncode(\n    JSON.stringify({\n      sub: userId,\n      username: username ?? undefined,\n      iat: now,\n      exp: now + 30 * 24 * 60 * 60, // 30 days\n    }),\n  );\n  const signature = sign(header, payload, secret);\n  return `${header}.${payload}.${signature}`;\n}\n\n/**\n * Verify a CLI JWT from the Authorization header.\n * Returns the user_id (sub) if valid, null otherwise.\n */\nexport function verifyCliToken(authHeader: string | null): string | null {\n  if (!authHeader?.startsWith(\"Bearer \")) return null;\n\n  const secret = process.env.CLI_JWT_SECRET;\n  if (!secret) return null;\n\n  const token = authHeader.slice(7);\n  const parts = token.split(\".\");\n  if (parts.length !== 3) return null;\n\n  const [header, payload, signature] = parts as [string, string, string];\n\n  // Verify signature\n  const expectedSig = sign(header, payload, secret);\n  const sigBuf = Buffer.from(signature, \"utf-8\");\n  const expectedBuf = Buffer.from(expectedSig, \"utf-8\");\n  if (sigBuf.length !== expectedBuf.length || !timingSafeEqual(sigBuf, expectedBuf)) {\n    return null;\n  }\n\n  // Decode and check expiry\n  let decoded: JwtPayload;\n  try {\n    decoded = JSON.parse(base64urlDecode(payload));\n  } catch {\n    return null;\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (!decoded.sub || !decoded.exp || decoded.exp < now) {\n    return null;\n  }\n\n  return decoded.sub;\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AASA,SAAS,gBAAgB,IAAY;IACnC,OAAO,OAAO,IAAI,CAAC,MAAM,SACtB,QAAQ,CAAC,UACT,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,OAAO;AACpB;AAEA,SAAS,gBAAgB,GAAW;IAClC,MAAM,SAAS,MAAM,IAAI,MAAM,CAAC,CAAC,IAAK,IAAI,MAAM,GAAG,CAAE,IAAI;IACzD,OAAO,OAAO,IAAI,CAAC,OAAO,OAAO,CAAC,MAAM,KAAK,OAAO,CAAC,MAAM,MAAM,UAAU,QAAQ,CAAC;AACtF;AAEA,SAAS,KAAK,MAAc,EAAE,OAAe,EAAE,MAAc;IAC3D,MAAM,QAAQ,GAAG,OAAO,CAAC,EAAE,SAAS;IACpC,OAAO,IAAA,mIAAU,EAAC,UAAU,QACzB,MAAM,CAAC,OACP,MAAM,CAAC,UACP,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,OAAO;AACpB;AAKO,SAAS,eAAe,MAAc,EAAE,QAAuB;IACpE,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;IACzC,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAE7B,MAAM,SAAS,gBAAgB,KAAK,SAAS,CAAC;QAAE,KAAK;QAAS,KAAK;IAAM;IACzE,MAAM,MAAM,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;IACpC,MAAM,UAAU,gBACd,KAAK,SAAS,CAAC;QACb,KAAK;QACL,UAAU,YAAY;QACtB,KAAK;QACL,KAAK,MAAM,KAAK,KAAK,KAAK;IAC5B;IAEF,MAAM,YAAY,KAAK,QAAQ,SAAS;IACxC,OAAO,GAAG,OAAO,CAAC,EAAE,QAAQ,CAAC,EAAE,WAAW;AAC5C;AAMO,SAAS,eAAe,UAAyB;IACtD,IAAI,CAAC,YAAY,WAAW,YAAY,OAAO;IAE/C,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;IACzC,IAAI,CAAC,QAAQ,OAAO;IAEpB,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,MAAM,QAAQ,MAAM,KAAK,CAAC;IAC1B,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;IAE/B,MAAM,CAAC,QAAQ,SAAS,UAAU,GAAG;IAErC,mBAAmB;IACnB,MAAM,cAAc,KAAK,QAAQ,SAAS;IAC1C,MAAM,SAAS,OAAO,IAAI,CAAC,WAAW;IACtC,MAAM,cAAc,OAAO,IAAI,CAAC,aAAa;IAC7C,IAAI,OAAO,MAAM,KAAK,YAAY,MAAM,IAAI,CAAC,IAAA,wIAAe,EAAC,QAAQ,cAAc;QACjF,OAAO;IACT;IAEA,0BAA0B;IAC1B,IAAI;IACJ,IAAI;QACF,UAAU,KAAK,KAAK,CAAC,gBAAgB;IACvC,EAAE,OAAM;QACN,OAAO;IACT;IAEA,MAAM,MAAM,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;IACpC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ,GAAG,GAAG,KAAK;QACrD,OAAO;IACT;IAEA,OAAO,QAAQ,GAAG;AACpB"}},
    {"offset": {"line": 146, "column": 0}, "map": {"version":3,"sources":["file:///Users/ohong/dev/straude/apps/web/app/api/usage/submit/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport { createClient as createServiceClient } from \"@supabase/supabase-js\";\nimport { verifyCliToken } from \"@/lib/api/cli-auth\";\nimport type { UsageSubmitRequest, UsageSubmitResponse, CcusageDailyEntry } from \"@/types\";\n\nconst MAX_BACKFILL_DAYS = 7;\n\nfunction getServiceClient() {\n  return createServiceClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SECRET_KEY!,\n  );\n}\n\nfunction isValidDate(dateStr: string): boolean {\n  const match = dateStr.match(/^(\\d{4})-(\\d{2})-(\\d{2})$/);\n  if (!match) return false;\n  const d = new Date(dateStr);\n  return !isNaN(d.getTime());\n}\n\nfunction isWithinBackfillWindow(dateStr: string): boolean {\n  const now = new Date();\n  const target = new Date(dateStr);\n  const diffMs = now.getTime() - target.getTime();\n  const diffDays = diffMs / (1000 * 60 * 60 * 24);\n  return diffDays >= -1 && diffDays <= MAX_BACKFILL_DAYS;\n}\n\nfunction validateEntry(entry: CcusageDailyEntry): string | null {\n  if (entry.costUSD < 0) return `Negative cost for ${entry.date}`;\n  if (entry.inputTokens < 0) return `Negative input tokens for ${entry.date}`;\n  if (entry.outputTokens < 0) return `Negative output tokens for ${entry.date}`;\n  if (entry.totalTokens < 0) return `Negative total tokens for ${entry.date}`;\n  return null;\n}\n\nasync function resolveUserId(request: Request): Promise<string | null> {\n  // Try CLI JWT first\n  const authHeader = request.headers.get(\"authorization\");\n  const cliUserId = verifyCliToken(authHeader);\n  if (cliUserId) return cliUserId;\n\n  // Fall back to Supabase session (web)\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n  return user?.id ?? null;\n}\n\nexport async function POST(request: Request) {\n  let body: UsageSubmitRequest;\n  try {\n    body = await request.json();\n  } catch {\n    return NextResponse.json({ error: \"Invalid JSON\" }, { status: 400 });\n  }\n\n  if (!body.entries || !Array.isArray(body.entries) || body.entries.length === 0) {\n    return NextResponse.json({ error: \"No entries provided\" }, { status: 400 });\n  }\n\n  if (!body.source || ![\"cli\", \"web\"].includes(body.source)) {\n    return NextResponse.json({ error: \"Invalid source\" }, { status: 400 });\n  }\n\n  const userId = await resolveUserId(request);\n  if (!userId) {\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n  }\n\n  // Validate all entries\n  for (const entry of body.entries) {\n    if (!isValidDate(entry.date)) {\n      return NextResponse.json({ error: `Invalid date: ${entry.date}` }, { status: 400 });\n    }\n    if (!isWithinBackfillWindow(entry.date)) {\n      return NextResponse.json(\n        { error: `Date ${entry.date} is outside the ${MAX_BACKFILL_DAYS}-day backfill window` },\n        { status: 400 },\n      );\n    }\n    const validationError = validateEntry(entry.data);\n    if (validationError) {\n      return NextResponse.json({ error: validationError }, { status: 400 });\n    }\n  }\n\n  const db = getServiceClient();\n  const isVerified = body.source === \"cli\";\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL ?? \"https://straude.com\";\n  const results: UsageSubmitResponse[\"results\"] = [];\n\n  for (const entry of body.entries) {\n    const { data: usage, error: usageError } = await db\n      .from(\"daily_usage\")\n      .upsert(\n        {\n          user_id: userId,\n          date: entry.date,\n          cost_usd: entry.data.costUSD,\n          input_tokens: entry.data.inputTokens,\n          output_tokens: entry.data.outputTokens,\n          cache_creation_tokens: entry.data.cacheCreationTokens,\n          cache_read_tokens: entry.data.cacheReadTokens,\n          total_tokens: entry.data.totalTokens,\n          models: entry.data.models,\n          is_verified: isVerified,\n          raw_hash: body.hash ?? null,\n          updated_at: new Date().toISOString(),\n        },\n        { onConflict: \"user_id,date\" },\n      )\n      .select(\"id\")\n      .single();\n\n    if (usageError || !usage) {\n      return NextResponse.json(\n        { error: `Failed to upsert usage for ${entry.date}: ${usageError?.message}` },\n        { status: 500 },\n      );\n    }\n\n    // Upsert post linked to the daily_usage record\n    const { data: post, error: postError } = await db\n      .from(\"posts\")\n      .upsert(\n        {\n          user_id: userId,\n          daily_usage_id: usage.id,\n          updated_at: new Date().toISOString(),\n        },\n        { onConflict: \"daily_usage_id\" },\n      )\n      .select(\"id\")\n      .single();\n\n    if (postError || !post) {\n      return NextResponse.json(\n        { error: `Failed to create post for ${entry.date}: ${postError?.message}` },\n        { status: 500 },\n      );\n    }\n\n    results.push({\n      date: entry.date,\n      usage_id: usage.id,\n      post_id: post.id,\n      post_url: `${appUrl}/post/${post.id}`,\n    });\n  }\n\n  return NextResponse.json({ results } satisfies UsageSubmitResponse);\n}\n"],"names":[],"mappings":"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"}}]
}