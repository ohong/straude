# Consolidated Code Review

## High Severity

1. File path and line: `apps/web/next.config.ts:5`, `apps/web/app/api/posts/[id]/route.ts:95`
Severity: high
Category: Diff
Description: `next/image` is configured with `remotePatterns` hostname `"**"` (allow any host), and post editing still accepts arbitrary image URLs. This creates a broad server-side fetch surface via image optimization and increases SSRF/security misconfiguration risk. Expanding image count to 10 amplifies blast radius.
Suggested fix: Restrict `remotePatterns` to known storage/CDN domains only, and validate/sanitize image URLs in the post PATCH route (scheme + host allowlist) before persisting.

2. File path and line: `apps/web/__tests__/api/usage-submit.test.ts:47`, `apps/web/app/api/usage/submit/route.ts:93`
Severity: high
Category: Diff
Description: The new pre-upsert existence check (`select(...).eq(...).maybeSingle()`) is not represented in test mocks. Targeted run (`bun run test __tests__/api/usage-submit.test.ts`) now fails 6 tests with `TypeError: ...eq is not a function`, so this changed path is not protected by passing tests.
Suggested fix: Update the mocked query chain to include `.eq()` and `.maybeSingle()`, adjust expected call ordering for existing-check + usage upsert + post upsert, and add assertions for `action` (`created` vs `updated`).

3. File path and line: `packages/cli/__tests__/commands/sync.test.ts:102`, `packages/cli/__tests__/flows/cli-sync-flow.test.ts:210`, `packages/cli/__tests__/flows/cli-sync-flow.test.ts:285`
Severity: high
Category: Diff
Description: CLI tests are stale versus new behavior. Same-day sync now re-pushes (`days: 1`), but tests still expect "already synced" no-op. API error copy changed (401/404 now custom guidance), but tests still expect legacy messages. Targeted run (`bun run test ...sync...push...flow...`) fails 4 tests.
Suggested fix: Update tests to expect same-day re-sync, and align 401/404 assertions with new user-facing errors.

## Medium Severity

4. File path and line: `apps/web/app/(app)/recap/page.tsx:25`, `apps/web/app/recap/[username]/opengraph-image.tsx:84`
Severity: medium
Category: Diff
Description: Recap sharing is inconsistent. The copied URL includes `?period=week|month`, but OG generation is hardcoded to `"week"`; monthly shares preview weekly cards. The copied URL is also hardcoded to `https://straude.com`, which is incorrect for staging/self-hosted environments.
Suggested fix: Derive share origin from runtime/env, and make OG image period-aware (query-aware route or period-in-path design) so shared preview matches selected period.

5. File path and line: `apps/web/lib/email/send-comment-email.ts:64`, `apps/web/app/api/unsubscribe/route.ts:5`
Severity: medium
Category: Diff
Description: Email headers advertise one-click unsubscribe (`List-Unsubscribe-Post`), but the unsubscribe endpoint only implements `GET`. Some clients execute one-click via `POST`, so unsubscribe can silently fail.
Suggested fix: Add a `POST` handler for one-click unsubscribe payloads while keeping `GET` fallback.

6. File path and line: `apps/web/app/api/unsubscribe/route.ts:17`
Severity: medium
Category: Diff
Description: The unsubscribe DB update result is not checked. The route always returns success HTML even if the update fails.
Suggested fix: Capture `{ error }` from the update call and return an error response/page on failure; log failures for diagnosis.

7. File path and line: `apps/web/lib/achievements.ts:81`
Severity: medium
Category: Diff
Description: Achievement awarding loads all `daily_usage` rows on every submit and then inserts new awards without conflict handling. This is O(n) per submit and can race under concurrent requests.
Suggested fix: Use DB-side aggregates (`sum/count`) instead of full-row reads and insert with conflict-safe semantics (`upsert`/`onConflict` on `(user_id, achievement_slug)`).

8. File path and line: `apps/web/components/app/feed/ActivityCard.tsx:121`
Severity: medium
Category: Diff
Description: The card-level `onKeyDown` handles `Enter` for navigation on a container that contains interactive descendants (e.g., image buttons). Keyboard activation can trigger unintended route navigation instead of the intended child action.
Suggested fix: Ignore key events from interactive descendants (`button`, `input`, `a`, etc.) or move navigation semantics to a non-ancestor wrapper.

9. File path and line: repository directories (`apps/web`, `packages/cli`, `docs`)
Severity: medium
Category: Holistic
Description: No `AGENTS.md` files were found in major project areas, and no directory-level `CLAUDE.md` symlink pattern is present. Agent operating context is centralized only at root, reducing local guardrails.
Suggested fix: Add per-directory `AGENTS.md` with conventions/testing pitfalls and symlink `CLAUDE.md` to each for compatibility.

10. File path and line: `apps/web/lib/supabase/service.ts:5`, `apps/web/lib/supabase/server.ts:7`
Severity: medium
Category: Holistic
Description: Environment configuration is not centrally validated; many runtime paths rely on non-null assertions and scattered `process.env` reads. Failures will occur late and inconsistently.
Suggested fix: Introduce a shared config module with startup validation (e.g., zod/envalid), then consume typed config across web + CLI.

## Low Severity

11. File path and line: `packages/cli/src/config.ts:8`, `packages/cli/package.json:3`
Severity: low
Category: Diff
Description: CLI runtime version constant is `0.1.4` while package version is `0.1.5`, so `--version`/help can report stale version info.
Suggested fix: Keep a single source of truth for version (inject from package metadata at build/release time).

12. File path and line: `packages/cli/README.md:30`
Severity: low
Category: Diff
Description: CLI docs still state same-day runs print stats and exit, but behavior now re-syncs same day and may update existing posts.
Suggested fix: Update README command behavior and examples to match current sync semantics.

13. File path and line: `apps/web/__tests__/` (no recap test coverage found)
Severity: low
Category: Diff
Description: Newly added recap surface (`/api/recap`, `/api/recap/image`, public recap + OG) has no dedicated tests, which allowed period/share regressions to ship.
Suggested fix: Add focused API tests for recap routes and at least one integration test validating period-consistent share output.

## Summary

Total issues: 13
Severity breakdown: high 3, medium 7, low 3
Agents that ran: Agent 1 (Diff Review), Agent 2 (Holistic Review)
Overall assessment: Recent feature work is substantial and directionally good, but there are immediate correctness/test failures in changed paths and one high-risk security configuration that should be addressed before release.
